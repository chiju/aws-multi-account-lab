name: Organization Setup

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

env:
  AWS_REGION: eu-central-1
  TERRAGRUNT_VERSION: 0.96.0

permissions:
  id-token: write
  contents: read

jobs:
  organization-setup:
    name: Organization Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.3"

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_ROOT }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Organization
        if: github.event.inputs.action == 'plan'
        working-directory: terragrunt/organization/01-organization
        run: terragrunt plan --all --non-interactive

      - name: Plan with Output File
        if: github.event.inputs.action == 'apply'
        working-directory: terragrunt/organization/01-organization
        run: terragrunt plan --all --non-interactive -out=plan.tfplan

      - name: Upload Plan Files
        if: github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plans
          path: "terragrunt/organization/01-organization/**/*.tfplan"
          retention-days: 1

      - name: Apply Exact Plan
        if: github.event.inputs.action == 'apply'
        working-directory: terragrunt/organization/01-organization
        run: terragrunt apply --all --non-interactive plan.tfplan

      - name: Get Account IDs
        if: github.event.inputs.action == 'apply'
        working-directory: terragrunt/organization/01-organization/02-platform-ou/03-accounts
        run: |
          echo "ðŸ“‹ Created Account IDs:"
          cd dev && echo "Dev: $(terragrunt output -raw id)"
          cd ../staging && echo "Staging: $(terragrunt output -raw id)"
          cd ../prod && echo "Prod: $(terragrunt output -raw id)"

      - name: Destroy Organization
        if: github.event.inputs.action == 'destroy'
        working-directory: terragrunt/organization/01-organization
        run: terragrunt destroy --all --non-interactive --auto-approve

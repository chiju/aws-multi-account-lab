name: Multi-Account Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply

env:
  AWS_REGION: eu-central-1
  TERRAGRUNT_VERSION: 0.96.0
  TERRAFORM_VERSION: 1.14.3

permissions:
  id-token: write
  contents: read

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: terragrunt
        run: |
          echo "ðŸ” Checking Terraform formatting..."
          find . -name "*.tf" -exec terraform fmt -check=true -diff=true {} \;

  validate-modules:
    name: Validate Modules
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Validate Terraform Modules
        working-directory: terragrunt
        run: |
          echo "âœ… Validating Terraform modules..."
          for dir in modules/*/; do
            if [ -f "$dir/main.tf" ]; then
              echo "Validating $dir"
              cd "$dir"
              terraform init -backend=false
              terraform validate
              cd - > /dev/null
            fi
          done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Checkov
        run: |
          pip3 install checkov
          checkov -d terragrunt --framework terraform --soft-fail

  plan-dev:
    name: Plan Dev Infrastructure
    runs-on: ubuntu-latest
    needs: [format-check, validate-modules, security-scan]
    if: github.event.inputs.action == 'plan'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Dev Infrastructure
        working-directory: terragrunt/infrastructure/dev
        env:
          TF_VAR_github_app_id: ${{ secrets.ARGOCD_APP_ID }}
          TF_VAR_github_app_installation_id: ${{ secrets.ARGOCD_APP_INSTALLATION_ID }}
          TF_VAR_github_app_private_key: ${{ secrets.ARGOCD_APP_PRIVATE_KEY }}
        run: terragrunt plan --all --non-interactive

  deploy-dev:
    name: Deploy Dev Infrastructure
    runs-on: ubuntu-latest
    needs: [format-check, validate-modules, security-scan]
    if: github.event.inputs.action == 'apply'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Apply Dev Infrastructure
        working-directory: terragrunt/infrastructure/dev
        env:
          TF_VAR_github_app_id: ${{ secrets.ARGOCD_APP_ID }}
          TF_VAR_github_app_installation_id: ${{ secrets.ARGOCD_APP_INSTALLATION_ID }}
          TF_VAR_github_app_private_key: ${{ secrets.ARGOCD_APP_PRIVATE_KEY }}
        run: terragrunt apply --all --auto-approve --non-interactive

  plan-staging:
    name: Plan Staging Infrastructure
    runs-on: ubuntu-latest
    needs: [format-check, validate-modules, security-scan]
    if: false  # Disabled - enable when ready
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Staging Infrastructure
        if: github.event.inputs.action == 'plan'
        working-directory: terragrunt/organization/01-organization/02-platform-ou/03-accounts/staging
        run: terragrunt plan --all --non-interactive

      - name: Plan with Output Files
        if: github.event.inputs.action == 'apply'
        working-directory: terragrunt/organization/01-organization/02-platform-ou/03-accounts/staging
        run: terragrunt plan --all --out-dir /tmp/staging-plans --non-interactive

      - name: Upload Plan Files
        if: github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: staging-plans
          path: "/tmp/staging-plans/**/*.tfplan"
          retention-days: 1

      - name: Apply Exact Plans
        if: github.event.inputs.action == 'apply'
        working-directory: terragrunt/organization/01-organization/02-platform-ou/03-accounts/staging
        run: terragrunt apply --all --out-dir /tmp/staging-plans --non-interactive

  deploy-prod:
    name: Prod Infrastructure
    runs-on: ubuntu-latest
    needs: [format-check, validate-modules, security-scan]
    if: false  # Disabled - enable when ready
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Prod Infrastructure
        if: github.event.inputs.action == 'plan'
        working-directory: terragrunt/organization/01-organization/02-platform-ou/03-accounts/prod
        run: terragrunt plan --all --non-interactive

      - name: Plan with Output Files
        if: github.event.inputs.action == 'apply'
        working-directory: terragrunt/organization/01-organization/02-platform-ou/03-accounts/prod
        run: terragrunt plan --all --out-dir /tmp/prod-plans --non-interactive

      - name: Upload Plan Files
        if: github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: prod-plans
          path: "/tmp/prod-plans/**/*.tfplan"
          retention-days: 1

      - name: Apply Exact Plans
        if: github.event.inputs.action == 'apply'
        working-directory: terragrunt/organization/01-organization/02-platform-ou/03-accounts/prod
        run: terragrunt apply --all --out-dir /tmp/prod-plans --non-interactive
